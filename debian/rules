#!/usr/bin/make -f

# Split this up a bit to avoid long lines
CONFIGURE_GDA_PATH = /usr/share/gnome-control-center/default-apps
CONFIGURE_GDA = --with-gnome-default-applications=$(CONFIGURE_GDA_PATH)
CONFIGURE_CFLAGS = CFLAGS="-Wl,--as-needed -Wall -g -O2"
CONFIGURE_DIRS = TOP_DIR=../.. PREFIX=/usr
CONFIGURE_COMMON = $(CONFIGURE_GDA) $(CONFIGURE_CFLAGS) $(CONFIGURE_DIRS)

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
CONFIGURE_COMMON += --parallel=$(NUMJOBS)
endif

%:
	dh $@

override_dh_auto_configure:
	python mscript.py configure $(CONFIGURE_COMMON) \
		--build-dir=debian/build-gtk2 --disable-gtk3
	python mscript.py configure $(CONFIGURE_COMMON) \
		--build-dir=debian/build-gtk3 --enable-gtk3

override_dh_auto_build:
	python mscript.py build --build-dir=debian/build-gtk2
	python mscript.py build --build-dir=debian/build-gtk3

override_dh_auto_install:
	install -d debian/roxterm-gtk2/usr/bin debian/roxterm-gtk3/usr/bin
	libtool --mode=install install debian/build-gtk2/roxterm \
		debian/build-gtk2/roxterm-config \
		debian/roxterm-gtk2/usr/bin
	python mscript.py build --build-dir=debian/build-gtk3 \
		--destdir=../roxterm-common
	mv debian/roxterm-common/usr/bin/* debian/roxterm-gtk3/usr/bin

override_dh_install:
	dh_install
	dh_install -proxterm-common debian/roxterm.xpm usr/share/pixmaps/

override_dh_auto_test:

override_dh_auto_clean:
	python mscript.py clean --build-dir=debian/build-gtk2
	rm -rf debian/build-gtk2 debian/build-gtk3
